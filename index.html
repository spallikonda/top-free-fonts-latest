<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Top Web Fonts - Live Trends Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-16 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <h1 class="text-4xl md:text-6xl font-bold mb-4">Top Web Fonts - Trends Tracker</h1>
            <p class="text-lg md:text-xl opacity-90">Historical tracking of font popularity over time</p>
            <p class="text-sm mt-2 opacity-75" id="lastUpdated">Loading...</p>
        </div>
    </header>

    <!-- Trend Navigation -->
    <div class="max-w-6xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Historical Data</h3>
                    <p class="text-sm text-gray-600">View font trends from previous days</p>
                </div>
                <div class="flex flex-wrap gap-2" id="dateLinks">
                    <!-- Date links will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="max-w-6xl mx-auto px-4 py-12">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
            <p class="text-xl font-semibold text-gray-700">Fetching latest font trends...</p>
            <p class="text-gray-500 mt-2">This may take a moment</p>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-6xl mx-auto px-4 py-12 space-y-8 hidden">
        <!-- Trend Chart Section -->
        <section class="bg-white rounded-lg shadow-lg p-6 md:p-8">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">Font Popularity Timeline</h2>
            <div id="trendChart" class="space-y-4">
                <!-- Chart will be rendered here -->
            </div>
        </section>

        <!-- Current Top Fonts -->
        <div id="currentFonts" class="space-y-8">
            <!-- Font cards will be inserted here -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 px-4 mt-16">
        <div class="max-w-6xl mx-auto text-center">
            <p class="text-lg font-semibold mb-2">Data automatically refreshed daily</p>
            <p class="text-gray-400">Historical tracking powered by AI web search</p>
            <p class="text-sm text-gray-500 mt-4">¬© 2024 Web Developer Community Resource</p>
        </div>
    </footer>

    <script>
        /******************************
         * CONFIG ‚Äî Update PROXY_URL *
         ******************************/
        const PROXY_URL = "https://eloquent-bubblegum-cbb995.netlify.app/.netlify/functions/gemini";

        // Your GitHub Pages origin (used by proxy to validate origin)
        const SITE_ORIGIN = "https://spallikonda.github.io";

        /**********************
         * APP STATE & STORAGE
         **********************/
        let allHistoricalData = {};
        let currentDate = null;

        // Storage keys
        const STORAGE_PREFIX = 'font-trends:';
        const LAST_FETCH_KEY = 'font-trends:last-fetch';

        /**********************
         * Initialization
         **********************/
        async function initializePage() {
            await loadHistoricalData();
            checkAndFetchIfNeeded();
            renderDateLinks();

            const dates = Object.keys(allHistoricalData).sort().reverse();
            currentDate = dates[0] || getTodayKey();

            if (allHistoricalData[currentDate]) {
                renderContent();
            } else {
                await fetchLatestFonts();
            }
        }

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        async function checkAndFetchIfNeeded() {
            try {
                const lastFetchResult = await window.storage.get(LAST_FETCH_KEY);
                const lastFetch = lastFetchResult ? lastFetchResult.value : null;
                const today = getTodayKey();

                if (lastFetch !== today) {
                    await fetchLatestFonts();
                }
            } catch (error) {
                console.log('First time setup, fetching data...');
                await fetchLatestFonts();
            }
        }

        async function loadHistoricalData() {
            try {
                const keys = await window.storage.list(STORAGE_PREFIX);

                if (keys && keys.keys) {
                    for (const key of keys.keys) {
                        if (key.startsWith(STORAGE_PREFIX) && key !== LAST_FETCH_KEY) {
                            try {
                                const result = await window.storage.get(key);
                                if (result) {
                                    const dateKey = key.replace(STORAGE_PREFIX, '');
                                    allHistoricalData[dateKey] = JSON.parse(result.value);
                                }
                            } catch (e) {
                                console.log(`Could not load ${key}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('No historical data found, starting fresh');
            }
        }

        async function saveCurrentData(dateKey, data) {
            try {
                await window.storage.set(
                    STORAGE_PREFIX + dateKey,
                    JSON.stringify(data)
                );
                await window.storage.set(LAST_FETCH_KEY, dateKey);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        /*******************************
         * Fetch latest fonts via proxy
         * (Netlify function -> Gemini)
         *******************************/
        async function fetchLatestFonts() {
            try {
                // Helpful UI if the developer forgot to set PROXY_URL
                if (!PROXY_URL || PROXY_URL.includes('https://eloquent-bubblegum-cbb995.netlify.app/')) {
                    document.getElementById('loadingState').innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                            <div class="text-yellow-500 text-6xl mb-4">‚ö†Ô∏è</div>
                            <p class="text-xl font-semibold text-gray-700 mb-2">Proxy not configured</p>
                            <p class="text-gray-500 mb-4">Set <code>PROXY_URL</code> to your Netlify function URL and redeploy.</p>
                            <p class="text-sm text-gray-600">Example: https://my-font-api.netlify.app/.netlify/functions/gemini</p>
                        </div>
                    `;
                    throw new Error('PROXY_URL not configured');
                }

                const today = getTodayKey();
                const todayDisplay = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Gemini expects a JSON body in its generateContent format.
                // We send a single "content" request whose text asks for a strict JSON array.
                const promptText = `Search the web for the most popular and widely used fonts on websites in ${new Date().getFullYear()}. Find current data and statistics. Return ONLY a valid JSON array (no markdown, no backticks) of the top 10 fonts. Each object must have:
1. name (exact name as on Google Fonts)
2. designer
3. category (serif/sans-serif)
4. description (2-3 sentences)
5. useCases (array of strings)
6. popularity (brief string explaining why it's popular now)
Return strictly JSON only.`;

                const requestBody = {
                    // Use the parts text content format Gemini expects
                    content: [
                        {
                            type: "text",
                            text: promptText
                        }
                    ],
                    // you can add safety or temperature settings if desired
                    // e.g. temperature: 0.2, maxOutputTokens: 1500
                };

                // Call your proxy (Netlify function) ‚Äî it adds the API key server-side
                const response = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestBody)
                });

                // Attempt to parse Gemini-style response proxied back
                const text = await response.text();

                // The Netlify function returns the raw Gemini response JSON text as string.
                // Parse it to an object
                let gemini;
                try {
                    gemini = JSON.parse(text);
                } catch (e) {
                    // If Gemini wrapped text differently, try to extract plain text and then JSON
                    const jsonMatch = text.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        gemini = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('Could not parse Gemini response JSON');
                    }
                }

                // Gemini response shape: { candidates: [{ content: { parts: [{ text: "..." }] } }] }
                const textContent =
                    gemini?.candidates?.[0]?.content?.parts?.[0]?.text ||
                    gemini?.candidates?.[0]?.content?.text ||
                    gemini?.output?.[0]?.content?.text ||
                    '';

                if (!textContent) {
                    throw new Error('No text content returned from Gemini');
                }

                // Extract JSON array inside returned text
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('Could not find JSON array in Gemini output');
                }

                const fontsData = JSON.parse(jsonMatch[0]);

                // Save to storage
                allHistoricalData[today] = {
                    date: todayDisplay,
                    fonts: fontsData
                };

                await saveCurrentData(today, allHistoricalData[today]);

                currentDate = today;
                renderDateLinks();
                renderContent();

                document.getElementById('lastUpdated').textContent = `Last updated: ${todayDisplay}`;
            } catch (error) {
                console.error('Error fetching fonts:', error);
                displayError();
            }
        }

        /**********************
         * Rendering functions
         **********************/
        function renderDateLinks() {
            const dateLinksContainer = document.getElementById('dateLinks');
            const dates = Object.keys(allHistoricalData).sort().reverse();

            dateLinksContainer.innerHTML = dates.map(dateKey => {
                const isActive = dateKey === currentDate;
                const displayDate = new Date(dateKey).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });

                return `
                    <button 
                        onclick="loadDate('${dateKey}')"
                        class="px-4 py-2 rounded-lg transition-colors ${
                            isActive 
                                ? 'bg-blue-600 text-white' 
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }"
                    >
                        ${displayDate}
                    </button>
                `;
            }).join('');

            if (dates.length === 0) {
                dateLinksContainer.innerHTML = '<p class="text-gray-500 text-sm">No historical data yet</p>';
            }
        }

        function loadDate(dateKey) {
            currentDate = dateKey;
            renderDateLinks();
            renderContent();
        }

        function renderContent() {
            const mainContent = document.getElementById('mainContent');
            const loadingState = document.getElementById('loadingState');
            const currentFontsContainer = document.getElementById('currentFonts');

            if (!allHistoricalData[currentDate]) {
                displayError();
                return;
            }

            const data = allHistoricalData[currentDate];
            const fontsData = data.fonts;

            // Load all fonts
            fontsData.forEach(font => {
                loadGoogleFont(font.name);
            });

            // Render trend chart
            renderTrendChart();

            // Render font cards
            setTimeout(() => {
                const colors = [
                    'blue-500', 'green-500', 'purple-500', 'red-500', 'indigo-500',
                    'yellow-500', 'teal-500', 'pink-500', 'amber-600', 'emerald-500'
                ];

                currentFontsContainer.innerHTML = fontsData.map((font, index) => {
                    const color = colors[index % colors.length];
                    const history = getFontHistory(font.name);

                    return `
                        <section class="bg-white rounded-lg shadow-lg p-6 md:p-8 hover:shadow-xl transition-shadow">
                            <div class="border-b-4 border-${color} pb-4 mb-6">
                                <div class="flex justify-between items-start flex-wrap gap-4">
                                    <div>
                                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800" style="font-family: '${font.name}', sans-serif;">
                                            ${index + 1}. ${font.name}
                                        </h2>
                                        <p class="text-sm text-gray-500 mt-1">
                                            ${font.designer ? `Designed by ${font.designer} ‚Ä¢ ` : ''}${font.category || 'Sans-serif'}
                                        </p>
                                    </div>
                                    ${history.length > 1 ? `
                                        <div class="bg-${color.replace('-500', '-50')} px-4 py-2 rounded-lg">
                                            <p class="text-xs font-semibold text-${color} uppercase">
                                                ${history.length} ${history.length === 1 ? 'Day' : 'Days'} Tracked
                                            </p>
                                            <p class="text-xs text-gray-600 mt-1">
                                                ${getPositionChange(font.name, index + 1)}
                                            </p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="font-family: '${font.name}', ${font.category === 'serif' ? 'serif' : 'sans-serif'};" class="space-y-4">
                                <p class="text-4xl md:text-5xl font-light">The quick brown fox jumps</p>
                                <p class="text-3xl md:text-4xl font-normal">${font.name} Typography</p>
                                <p class="text-2xl md:text-3xl font-semibold">Modern Web Design</p>
                                <p class="text-lg md:text-xl text-gray-700">${font.description || 'A popular web font choice for modern websites.'}</p>
                                
                                ${font.useCases && font.useCases.length > 0 ? `
                                    <div class="bg-gray-50 p-6 rounded-lg mt-6">
                                        <p class="text-xl font-bold mb-3">Best Use Cases:</p>
                                        <ul class="space-y-2">
                                            ${font.useCases.map(useCase => `
                                                <li class="flex items-start">
                                                    <span class="text-${color} mr-2">‚Ä¢</span>
                                                    <span>${useCase}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${font.popularity ? `
                                    <div class="bg-gradient-to-r from-${color.replace('-500', '-50')} to-${color.replace('-500', '-100')} p-4 rounded-lg mt-4">
                                        <p class="text-sm font-semibold">üí° ${font.popularity}</p>
                                    </div>
                                ` : ''}
                                
                                ${history.length > 1 ? `
                                    <div class="border-t pt-4 mt-4">
                                        <p class="text-sm font-semibold text-gray-700 mb-2">üìä Historical Ranking:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${history.map(h => `
                                                <span class="text-xs px-3 py-1 bg-gray-100 rounded-full">
                                                    ${h.date}: #${h.position}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                                    <div class="bg-gray-100 p-4 rounded text-center">
                                        <p class="text-3xl font-light">Aa</p>
                                        <p class="text-xs text-gray-600 mt-2">Light</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded text-center">
                                        <p class="text-3xl font-normal">Aa</p>
                                        <p class="text-xs text-gray-600 mt-2">Regular</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded text-center">
                                        <p class="text-3xl font-semibold">Aa</p>
                                        <p class="text-xs text-gray-600 mt-2">Semibold</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded text-center">
                                        <p class="text-3xl font-bold">Aa</p>
                                        <p class="text-xs text-gray-600 mt-2">Bold</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                    `;
                }).join('');

                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }, 1000);
        }

        function renderTrendChart() {
            const trendChartContainer = document.getElementById('trendChart');
            const dates = Object.keys(allHistoricalData).sort();

            if (dates.length < 2) {
                trendChartContainer.innerHTML = `
                    <p class="text-gray-500 text-center py-8">
                        Historical trend chart will appear after collecting data over multiple days
                    </p>
                `;
                return;
            }

            // Collect all unique fonts
            const allFonts = new Set();
            dates.forEach(dateKey => {
                allHistoricalData[dateKey].fonts.forEach(font => {
                    allFonts.add(font.name);
                });
            });

            const colors = ['blue', 'green', 'purple', 'red', 'orange', 'pink', 'teal', 'indigo', 'yellow', 'emerald'];

            trendChartContainer.innerHTML = `
                <div class="overflow-x-auto">
                    <div class="min-w-max space-y-2">
                        ${Array.from(allFonts).map((fontName, idx) => {
                            const history = getFontHistory(fontName);
                            const color = colors[idx % colors.length];

                            return `
                                <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
                                    <div class="w-32 font-semibold text-sm truncate">${fontName}</div>
                                    <div class="flex-1 flex gap-1">
                                        ${dates.map(dateKey => {
                                            const dataForDate = allHistoricalData[dateKey].fonts;
                                            const position = dataForDate.findIndex(f => f.name === fontName) + 1;

                                            if (position > 0) {
                                                return `
                                                    <div class="bg-${color}-500 text-white text-xs px-2 py-1 rounded" title="${dateKey}: #${position}">
                                                        ${position}
                                                    </div>
                                                `;
                                            } else {
                                                return `<div class="bg-gray-200 text-xs px-2 py-1 rounded text-gray-400">-</div>`;
                                            }
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getFontHistory(fontName) {
            const history = [];
            const dates = Object.keys(allHistoricalData).sort();

            dates.forEach(dateKey => {
                const data = allHistoricalData[dateKey];
                const position = data.fonts.findIndex(f => f.name === fontName) + 1;

                if (position > 0) {
                    const displayDate = new Date(dateKey).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                    history.push({ date: displayDate, position });
                }
            });

            return history;
        }

        function getPositionChange(fontName, currentPosition) {
            const history = getFontHistory(fontName);

            if (history.length < 2) return 'New entry';

            const previousPosition = history[history.length - 2].position;
            const change = previousPosition - currentPosition;

            if (change > 0) return `‚Üë Up ${change} ${change === 1 ? 'spot' : 'spots'}`;
            if (change < 0) return `‚Üì Down ${Math.abs(change)} ${Math.abs(change) === 1 ? 'spot' : 'spots'}`;
            return '‚Üí No change';
        }

        function loadGoogleFont(fontName) {
            const fontLink = document.createElement('link');
            fontLink.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}:wght@300;400;500;600;700&display=swap`;
            fontLink.rel = 'stylesheet';
            document.head.appendChild(fontLink);
        }

        async function manualRefresh() {
            const confirmRefresh = confirm('This will fetch the latest font trends from the web. Continue?');
            if (confirmRefresh) {
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('hidden');
                await fetchLatestFonts();
            }
        }

        function displayError() {
            const loadingState = document.getElementById('loadingState');
            loadingState.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                    <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                    <p class="text-xl font-semibold text-gray-700 mb-2">Unable to fetch data</p>
                    <p class="text-gray-500 mb-4">There was an error retrieving font trends</p>
                    <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        Try Again
                    </button>
                </div>
            `;
        }

        // Initialize on page load
        initializePage();
    </script>
</body>
</html>
